use mysql;
drop database if exists rep_gen;
create database if not exists rep_gen default charset cp1251;
use rep_gen;
/*Таблица задач*/ -- сделать
/*Таблица отчетов*/
create table reports(
	 r_id     bigint(11)   auto_increment not null comment 'Идентиикатор отчета',
    r_name   varchar(200)                not null comment 'Наименование отчета',
    r_code   varchar(20)                 not null comment 'Код формы отчета',
    r_status int(1)                      not null comment 'Статус',
    primary key(r_id)
);
insert into reports(r_name,r_code,r_status)values
    ('Отчет 1-А "Оперативная статистическая информация о состоянии преступности и результатах выявления и раскрытия преступлений"','F451',1),
    ('Отчет 4-ЕГС "Сведения о состоянии преступности и результатах расследования преступлений"','F494',1);
/*Таблица описателей отчетов*/
create table reports_descriptor(
	rd_id        bigint(11)   auto_increment not null comment 'Идентификатор описателя',
    rd_report_id varchar(200)                not null comment 'Идентификатор отчета',
    rd_name      varchar(1000)               not null comment 'Наименование раздела',
    rd_r         int(11)                     not null comment 'Номер раздела формы',
    rd_g         int(11)                     not null comment 'Количество граф в разделе формы',
    rd_s         int(11)                     not null comment 'Количество строк в разделе формы',
    rd_data      int(11)                     not null comment 'Дата последней актуализации формы в формате yyyymmdd',
    rd_status    int(1)                      not null comment 'Статус',
    primary key(rd_id)
);
insert into reports_descriptor(rd_report_id,rd_name,rd_r,rd_g,rd_s,rd_data,rd_status)values
    (2,'Общие сведения о состоянии преступности',1,29,27,20201104,1),
    (2,'Сведения о зарегистрированных, раскрытых и нераскрытых преступлениях',2,18,139,20201104,1),
    (2,'Общие сведения о выявленных и предварительно расследованных преступлениях субъектами учета',3,15,34,20201104,1),
    (2,'Сведения о преступлениях, совершенных отдельными категориями лиц (по расследованным преступлениям)',4,10,5,20201104,1),
    (2,'Сведения о преступлениях, совершенных иностранными гражданами и лицами без гражданства, а также в отношении иностранных граждан',5,2,6,20201104,1),
    (2,'Сведения о лицах, совершивших преступления',6,3,24,20201104,1),
    (2,'Cведения о зарегистрированных и предварительно расследованных преступлениях в отчетном периоде, совершенных в общественных местах и на улицах, а также на дорогах, трассах вне населенных пунктов',7,6,16,20201104,1),
    (2,'Сведения о преступлениях, укрытых субъектами регистрации',8,18,18,20201104,1),
    (2,'Сведения о зарегистрированных, раскрытых и нераскрытых преступлениях небольшой и средней тяжести, предварительное расследование по которым производится в форме дознания',9,11,15,20201104,1),
    (2,'Сведения о преступлениях, связанных с легализацией (отмыванием) денежных средств или иного имущества, сумме легализованных денежных средств, полученных преступным путем, и мерах по изъятию и аресту имущества, денег и ценностей',10,14,8,20201104,1),
    (2,'Сведения о преступлениях, совершенных с использованием информационно-телекоммуникационных технологий или в сфере компьютерной информации, выявленных и предварительно расследованных субъектами регистрации',11,24,52,20201104,1),
    (2,'Сведения о преступлениях, связанных с реализацией национальных и федеральных проектов (программ) в соответствии с Указом Президента РФ от 07.05.2018 № 204 "О национальных целях и стратегических задачах развития РФ на период до 2024 года"',12,26,54,20201104,1);    
/*Таблица детерминантов (библиотека главных запросов)*/
create table reports_main(
    rm_id     bigint(11)    auto_increment not null comment 'Идентификатор main запроса',
	rm_name   varchar(100)                 not null comment 'Название запроса',
    rm_sql    varchar(5000)                not null comment 'SQL-запрос',
    rm_status int(1)                       not null comment 'Статус',
    primary key(rm_id)
);
/*Отчет 494*/
insert into reports_main(rm_name,rm_sql,rm_status)values
    ('F494 Раздел 1 Детерминант','select * from {srez_f1} t left join {srez_f1_f4} t3 on t.d01_f10 = t3.d01_f3 and t.d1o_f10 = t3.d1o_f3 and t.d3o_f10 = t3.d3o_f3 and t.d3g_f10 = t3.d3g_f3 and t.d3n_f10 = t3.d3n_f3 and nvl(t.gas_org,0) = nvl(t3.gas_org,0) and t3.d04_f10 = t.d04_f10 WHERE t.d02_f10 in (1,2) and t.d3o_f10 in (1,2,3) and (((t.p25_f11 not in (12,13,14,15,16,17,18,20,21,25,26,29,32,33,34,36,37,38,40,43,44,46,47,48,49,50,60,67,68) or t.p25_f11 is null) and t.s25_f11 is null) or (t.p25_f11 in (1,8,31,35,61,62) and t.s25_f11 not in (12,13,14,15,16,17,18,20,21,25,26,29,32,33,34,36,37,38,40,43,44,46,47,48,49,50,59,60,67,68) and t.d06_f11 >= to_date('01.01.2020','dd.mm.yyyy'))) ORDER BY t.D01_F10, t.D3N_F10, t.D04_F10',1),
    ('F494 Раздел 2 Детерминант','',1),
	('F494 Раздел 3 Детерминант','',1),
	('F494 Раздел 4 Детерминант','',1),
	('F494 Раздел 5 Детерминант','',1),
	('F494 Раздел 6 Детерминант','',1),
	('F494 Раздел 7 Детерминант','',1),
	('F494 Раздел 8 Детерминант','',1),
	('F494 Раздел 9 Детерминант','',1),
	('F494 Раздел 10 Детерминант','',1),
	('F494 Раздел 11 Детерминант','',1),
	('F494 Раздел 12 Детерминант','',1);
/*Таблица соотношения главных запросов с отчетами*/
create table reports_determinant(
	 rdet_id        bigint(11) auto_increment not null comment 'Идентификатор детерминанта',
    rdet_report_id int(11)                   not null comment 'Идентификатор отчета',
    rdet_main_id   int(11)                   not null comment 'Идентификатор главного запроса',
    primary key(rdet_id)
);
/*Таблица условий по графам / строкам*/
create table reports_sidewall(
	 rs_id        bigint(11) auto_increment not null comment 'Идентификатор условия',
    rs_report_id int(11)                   not null comment 'Идентифкатор отчета',
    rs_type      int(11)                   not null comment 'Тип вектора 1 - графа, 2 - строка',
    rs_position  int(11)                   not null comment 'Номер позиции графоместа',
    rs_yes       int(11)                   not null comment 'Позиция перехода по Да',
    rs_no        int(11)                   not null comment 'Позиция перехода по Нет',
    primary key(rs_id)
);
/*Таблица технических заданий*/
create table reports_tech_action(
	rta_id         bigint(11) auto_increment not null comment 'Идентификатор',
	rta_sid        int(11)                   not null comment 'Идентификатор графоместа',
	rta_position   int(11)                   not null comment 'Номер позиции ТЗ',
	rta_yes        int(11)                   not null comment 'Номер позиции перехода по Да',
	rta_no         int(11)                   not null comment 'Номер позиции перехода по Нет',
	rta_field      varchar(50)               not null comment 'Наименование поля для условия',
	rta_expression varchar(2)                not null comment 'Математическое выражение',
	rta_value      varchar(200)              not null comment 'Значение выражения',
	primary key(rta_id)
);
/*Таблица подбора данных по мультиполям*/
create table reports_multi_fields(
	 rmf_id     bigint(11)  auto_increment not null comment 'Идентификатор мультиполя',
    rmf_in     varchar(50)                not null comment 'Входное поле',
    rmf_out    varchar(50)                not null comment 'Выходное поле',
    rmf_status int(1)                     not null comment 'Статус',
    primary key(rmf_id)
);
insert into reports_multi_fields(rmf_in, rmf_out,rmf_status)values
	('a091_f10','a091_f10',1),('b091_f10','a091_f10',1),
	('k131_f10','k131_f10',1),('k132_f10','k131_f10',1),('k133_f10','k131_f10',1),
	('szch1','szch1',1),('szch2','szch1',1),('szch3','szch1',1),
	('stz1','stz1',1),('stz2','stz1',1),('stz3','stz1',1),
	('tyg1','tyg1',1),('tyg2','tyg1',1),('tyg3','tyg1',1),
	('ob_pr_s1','ob_pr_s1',1),('ob_pr_s2','ob_pr_s1',1),('ob_pr_s3','ob_pr_s1',1),
	('napr1','napr1',1),('napr2','napr1',1),('napr3','napr1',1),
	('a23_f10','a23_f10',1),('b23_f10','a23_f10',1),('c23_f10','a23_f10',1),
	('a23o_f10','a23o_f10',1),('b23o_f10','a23o_f10',1),('c23o_f10','a23o_f10',1),	
	('a24_f10','a24_f10',1),('b24_f10','a24_f10',1),('c24_f10','a24_f10',1),
   ('a25k_f10','a25k_f10',1),('b25k_f10','a25k_f10',1),('c25k_f10','a25k_f10',1),('d25k_f10','a25k_f10',1),
   ('a25s_f10','a25s_f10',1),('b25s_f10','a25s_f10',1),('c25s_f10','a25s_f10',1),('d25s_f10','a25s_f10',1),
   ('a251k_f10','a251k_f10',1),('b251k_f10','a251k_f10',1),('c251k_f10','a251k_f10',1),('d251k_f10','a251k_f10',1),
   ('a251s_f10','a251s_f10',1),('b251s_f10','a251s_f10',1),('c251s_f10','a251s_f10',1),('d251s_f10','a251s_f10',1),
   ('a252k_f10','a252k_f10',1),('b252k_f10','a252k_f10',1),('c252k_f10','a252k_f10',1),
   ('a252s_f10','a252s_f10',1),('b252s_f10','a252s_f10',1),('c252s_f10','a252s_f10',1),
	('a26_f10','a26_f10',1),('b26_f10','a26_f10',1),('c26_f10','a26_f10',1),
	('a27_f10','a27_f10',1),('b27_f10','a27_f10',1),('c27_f10','a27_f10',1),('d27_f10','a27_f10',1),('e27_f10','a27_f10',1),('f27_f10','a27_f10',1),
	('a28_f10','a28_f10',1),('b28_f10','a28_f10',1),
	('a291_f10','a291_f10',1),('b291_f10','a291_f10',1),('c291_f10','a291_f10',1),('d291_f10','a291_f10',1),
	('a33_f10','a33_f10',1),('b33_f10','a33_f10',1),('c33_f10','a33_f10',1),('d33_f10','a33_f10',1),
	('a34_f10','a34_f10',1),('b34_f10','a34_f10',1),
	('a35_f10','a35_f10',1),('b35_f10','a35_f10',1),
	('a36_f10','a36_f10',1),('b36_f10','a36_f10',1),	
	('a37_f10','a37_f10',1),('b37_f10','a37_f10',1),	
	('a38_f10','a38_f10',1),('b38_f10','a38_f10',1),('c38_f10','a38_f10',1),
	('a39_f10','a39_f10',1),('b39_f10','a39_f10',1),	
	('a11_f11','a11_f11',1),('b11_f11','a11_f11',1),	
	('a12_f11','a12_f11',1),('b12_f11','a12_f11',1),('c12_f11','a12_f11',1),
	('a13_f11','a13_f11',1),('b13_f11','a13_f11',1),('c13_f11','a13_f11',1),('d13_f11','a13_f11',1),
	('a14_f11','a14_f11',1),('b14_f11','a14_f11',1),('c14_f11','a14_f11',1),
	('a15_f11','a15_f11',1),('b15_f11','a15_f11',1),	
	('a17_f11','a17_f11',1),('b17_f11','a17_f11',1),('c17_f11','a17_f11',1),
	('a18_f11','a18_f11',1),('b18_f11','a18_f11',1),		
	('a19_f11','a19_f11',1),('b19_f11','a19_f11',1),			
	('a20_f11','a20_f11',1),('b20_f11','a20_f11',1),			
	('a21_f11','a21_f11',1),('b21_f11','a21_f11',1),			
	('a22_f11','a22_f11',1),('b22_f11','a22_f11',1),			
	('a23_f11','a23_f11',1),('b23_f11','a23_f11',1),			
	('a24_f11','a24_f11',1),('b24_f11','a24_f11',1),			
	('a26_f11','a26_f11',1),('b26_f11','a26_f11',1),			
	('a27_f11','a27_f11',1),('b27_f11','a27_f11',1),			
	('a28k_f11','a28k_f11',1),('b28k_f11','a28k_f11',1),('c28k_f11','a28k_f11',1),('d28k_f11','a28k_f11',1),
	('a28s_f11','a28s_f11',1),('b28s_f11','a28s_f11',1),('c28s_f11','a28s_f11',1),('d28s_f11','a28s_f11',1),
	('a29_f11','a29_f11',1),('b29_f11','a29_f11',1),('c29_f11','a29_f11',1),
	('a30_f11','a30_f11',1),('b30_f11','a30_f11',1),			
	('a31_f11','a31_f11',1),('b31_f11','a31_f11',1),('c31_f11','a31_f11',1),
   ('a32_f11','a32_f11',1),('b32_f11','a32_f11',1),('c32_f11','a32_f11',1),('d32_f11','a32_f11',1),('e32_f11','a32_f11',1),
	('a321_f11','a321_f11',1),('b321_f11','a321_f11',1),			
	('a36_f11','a36_f11',1),('b36_f11','a36_f11',1),			
	('a09_f12','a09_f12',1),('b09_f12','a09_f12',1),			
	('a11_f12','a11_f12',1),('b11_f12','a11_f12',1),			
	('a17_f12','a17_f12',1),('b17_f12','a17_f12',1);

/*Таблица матриц, расчитанных отчетов*/
create table reports_matrix(
	m_id        bigint(11) auto_increment not null comment 'Идентификатор записи',
	m_year      int(4)                    not null comment 'Год',
	m_month     int(2)                    not null comment 'Месяw',
	m_report_id int(11)                   not null comment 'Идентификатор отчета',
	m_r         int(11)                   not null comment 'Номер раздела',
	m_s         int(11)                   not null comment 'Номер строки отчета',
	m_g001      float                     null comment 'Графа 001',
	m_g002      float                     null comment 'Графа 002',	
	m_g003      float                     null comment 'Графа 003',	
	m_g004      float                     null comment 'Графа 004',	
	m_g005      float                     null comment 'Графа 005',	
	m_g006      float                     null comment 'Графа 006',	
	m_g007      float                     null comment 'Графа 007',	
	m_g008      float                     null comment 'Графа 008',	
	m_g009      float                     null comment 'Графа 009',
	m_g010      float                     null comment 'Графа 010', 
	m_g011      float                     null comment 'Графа 011',
	m_g012      float                     null comment 'Графа 012',	
	m_g013      float                     null comment 'Графа 013',	
	m_g014      float                     null comment 'Графа 014',	
	m_g015      float                     null comment 'Графа 015',	
	m_g016      float                     null comment 'Графа 016',	
	m_g017      float                     null comment 'Графа 017',	
	m_g018      float                     null comment 'Графа 018',	
	m_g019      float                     null comment 'Графа 019',	
	m_g020      float                     null comment 'Графа 020', 
	m_g021      float                     null comment 'Графа 021',
	m_g022      float                     null comment 'Графа 022',	
	m_g023      float                     null comment 'Графа 023',	
	m_g024      float                     null comment 'Графа 024',	
	m_g025      float                     null comment 'Графа 025',	
	m_g026      float                     null comment 'Графа 026',	
	m_g027      float                     null comment 'Графа 027',	
	m_g028      float                     null comment 'Графа 028',	
	m_g029      float                     null comment 'Графа 029',		
	m_g030      float                     null comment 'Графа 030', 
	m_g031      float                     null comment 'Графа 031',
	m_g032      float                     null comment 'Графа 032',	
	m_g033      float                     null comment 'Графа 033',	
	m_g034      float                     null comment 'Графа 034',	
	m_g035      float                     null comment 'Графа 035',	
	m_g036      float                     null comment 'Графа 036',	
	m_g037      float                     null comment 'Графа 037',	
	m_g038      float                     null comment 'Графа 038',	
	m_g039      float                     null comment 'Графа 039',			
	m_g040      float                     null comment 'Графа 040', 
	m_g041      float                     null comment 'Графа 041',
	m_g042      float                     null comment 'Графа 042',	
	m_g043      float                     null comment 'Графа 043',	
	m_g044      float                     null comment 'Графа 044',	
	m_g045      float                     null comment 'Графа 045',	
	m_g046      float                     null comment 'Графа 046',	
	m_g047      float                     null comment 'Графа 047',	
	m_g048      float                     null comment 'Графа 048',	
	m_g049      float                     null comment 'Графа 049',	
	m_g050      float                     null comment 'Графа 050', 
	m_g051      float                     null comment 'Графа 051',
	m_g052      float                     null comment 'Графа 052',	
	m_g053      float                     null comment 'Графа 053',	
	m_g054      float                     null comment 'Графа 054',	
	m_g055      float                     null comment 'Графа 055',	
	m_g056      float                     null comment 'Графа 056',	
	m_g057      float                     null comment 'Графа 057',	
	m_g058      float                     null comment 'Графа 058',	
	m_g059      float                     null comment 'Графа 059',		
	m_g060      float                     null comment 'Графа 060', 
	m_g061      float                     null comment 'Графа 061',
	m_g062      float                     null comment 'Графа 062',	
	m_g063      float                     null comment 'Графа 063',	
	m_g064      float                     null comment 'Графа 064',	
	m_g065      float                     null comment 'Графа 065',	
	m_g066      float                     null comment 'Графа 066',	
	m_g067      float                     null comment 'Графа 067',	
	m_g068      float                     null comment 'Графа 068',	
	m_g069      float                     null comment 'Графа 069',			
	m_g070      float                     null comment 'Графа 070', 
	m_g071      float                     null comment 'Графа 071',
	m_g072      float                     null comment 'Графа 072',	
	m_g073      float                     null comment 'Графа 073',	
	m_g074      float                     null comment 'Графа 074',	
	m_g075      float                     null comment 'Графа 075',	
	m_g076      float                     null comment 'Графа 076',	
	m_g077      float                     null comment 'Графа 077',	
	m_g078      float                     null comment 'Графа 078',	
	m_g079      float                     null comment 'Графа 079',			
	m_g080      float                     null comment 'Графа 080', 
	m_g081      float                     null comment 'Графа 081',
	m_g082      float                     null comment 'Графа 082',	
	m_g083      float                     null comment 'Графа 083',	
	m_g084      float                     null comment 'Графа 084',	
	m_g085      float                     null comment 'Графа 085',	
	m_g086      float                     null comment 'Графа 086',	
	m_g087      float                     null comment 'Графа 087',	
	m_g088      float                     null comment 'Графа 088',	
	m_g089      float                     null comment 'Графа 089',		
	m_g090      float                     null comment 'Графа 090', 
	m_g091      float                     null comment 'Графа 091',
	m_g092      float                     null comment 'Графа 092',	
	m_g093      float                     null comment 'Графа 093',	
	m_g094      float                     null comment 'Графа 094',	
	m_g095      float                     null comment 'Графа 095',	
	m_g096      float                     null comment 'Графа 096',	
	m_g097      float                     null comment 'Графа 097',	
	m_g098      float                     null comment 'Графа 098',	
	m_g099      float                     null comment 'Графа 099',		
	m_g100      float                     null comment 'Графа 100',
	primary key(m_id)
);